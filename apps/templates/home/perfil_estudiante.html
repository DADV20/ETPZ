{% extends 'layouts/base.html' %}

{% block content %}
{% load tags %}
<div class="d-flex justify-content-center">
  <div class="card flex-shrink-1">
    <div class="card-body">
      <i class="fas fa-times close-card-x fa-lg" onClick="window.history.back();return false;"></i>
      <h5 class="card-title">{{ estudiante.nombre }} {{ estudiante.apellido }}</h5>
      <h6 class="card-subtitle mb-2 text-muted">{{ estudiante.ci_tipo }}-{{ estudiante.ci|remove_dot }}</h6>
      <p class="card-text">
          Entidad Federal: {{ estudiante.entidad_federal }}<br>
          Periodo: {{ estudiante.periodo|default_if_none:'No asignado' }}<br>
          Cursante de: {{ estudiante.periodo.carga|default_if_none:'No asignado' }}<br>
      </p>
      {% comment %}
      <a href="{% url 'estudiante_editar' estudiante.id %}" class="card-link"><i class="fas fa-edit"></i> Editar</a>
      <a href="{% url 'estudiante_eliminar' estudiante.id %}" class="card-link"><i class="fas fa-trash"></i> Eliminar</a>
      {% endcomment %}
      {% if estudiante.periodo %}
      <h5>Notas Periodo Actual</h5>
      <div class="table-responsive p-0">
          <table class="table mb-0">
            <thead>
              <tr class="text-xs">
                <th>Materia</th>
                <th colspan="2" class="text-center">Lapso 1</th>
                <th colspan="2" class="text-center">Lapso 2</th>
                <th colspan="2" class="text-center">Lapso 3</th>
                <th class="text-center">Definitiva Lapsos I, II, III</th>
                <th class="text-center">Total Inasist.</th>
              </tr>
            </thead>
            <tbody>
              <tr class="text-xs">
                <td></td>
                <td class="text-center">Calif.</td>
                <td class="text-center">Inas.</td>
                <td class="text-center">Calif.</td>
                <td class="text-center">Inas.</td>
                <td class="text-center">Calif.</td>
                <td class="text-center">Inas.</td>
                <td></td>
                <td></td>
              </tr>
              {% for nota in notas %}
                <tr id="row-{{ forloop.counter0 }}">
                  <td >{{ nota.materia|default_if_none:'-' }}</td>
                  <td val="{{ nota.lapso_1|default_if_none:'-' }}" class="text-center lap-1">{% if nota.materia.literales %}{{ nota.lapso_1|literales|default_if_none:'-' }}{% else %}{{ nota.lapso_1|default_if_none:'-' }}{% endif %}</td>
                  <td val="{{ nota.inasistencia_1|default_if_none:'0' }}" class="text-center f-ina-{{ forloop.counter0 }} ina-1">{{ nota.inasistencia_1|default_if_none:'0' }}</td>
                  <td val="{{ nota.lapso_2|default_if_none:'-' }}" class="text-center lap-2">{% if nota.materia.literales %}{{ nota.lapso_2|literales|default_if_none:'-' }}{% else %}{{ nota.lapso_2|default_if_none:'-' }}{% endif %}</td>
                  <td val="{{ nota.inasistencia_2|default_if_none:'0' }}" class="text-center f-ina-{{ forloop.counter0 }} ina-2">{{ nota.inasistencia_2|default_if_none:'0' }}</td>
                  <td val="{{ nota.lapso_3|default_if_none:'-' }}" class="text-center lap-3">{% if nota.materia.literales %}{{ nota.lapso_3|literales|default_if_none:'-' }}{% else %}{{ nota.lapso_3|default_if_none:'-' }}{% endif %}</td>
                  <td val="{{ nota.inasistencia_3|default_if_none:'0' }}" class="text-center f-ina-{{ forloop.counter0 }} ina-3">{{ nota.inasistencia_3|default_if_none:'0' }}</td>
                  <td val="{% if nota.reparacion %}{{ nota.reparacion|default_if_none:'-' }}{% else %}{{ nota.promedio }}{% endif %}" class="text-center final">{% if nota.reparacion %}{{ nota.reparacion|default_if_none:'-' }}{% else %}{{ nota.promedio }}{% endif %}</td>
                  <td class="text-center" id="ti-{{ forloop.counter0 }}"></td>
                </tr>
                {% endfor %}
                <tr class="fw-bold">
                  <td>Promedio por lapso:</td>
                  <td class="text-center" id="prom-1"></td>
                  <td class="text-center" id="pi-1"></td>
                  <td class="text-center" id="prom-2"></td>
                  <td class="text-center" id="pi-2"></td>
                  <td class="text-center" id="prom-3"></td>
                  <td class="text-center" id="pi-3"></td>
                  <td class="text-center" id="prom-f"></td>
                  <td class="text-center" id="ti-f"></td>
                </tr>
            </tbody>
          </table>
        </div>
        {% endif %}
      </div>
    </div>
</div>
<script>
$(document).ready(function() {
  function calcularPromedio(claseColumna, idResultado) {
      var sum = 0;
      var count = 0;
      $(claseColumna).each(function() {
          var value = parseFloat($(this).attr('val'));
          if (!isNaN(value)) {
              sum += value;
              count++;
          }
      });
      var promedio = (count > 0) ? (sum / count) : '-';
      if (promedio !== '-') {
          promedio = promedio.toFixed(2);
          if (promedio.endsWith('.00')) {
              promedio = promedio.substring(0, promedio.length - 3);
          }
          promedio = promedio.replace('.', ',');
      }
      $(idResultado).text(promedio);
  }
  calcularPromedio('.lap-1', '#prom-1');
  calcularPromedio('.ina-1', '#pi-1');
  calcularPromedio('.lap-2', '#prom-2');
  calcularPromedio('.ina-2', '#pi-2');
  calcularPromedio('.lap-3', '#prom-3');
  calcularPromedio('.ina-3', '#pi-3');
  calcularPromedio('.final', '#prom-f');

  function calculateRowSum(rowId) {
    var sum = 0;
    $('.f-ina-' + rowId).each(function() {
        var value = parseFloat($(this).attr('val'));
        if (!isNaN(value)) {
            sum += value;
        }
    });
    var displaySum = sum.toFixed(2).replace('.00', '').replace('.', ',');
    $('#ti-' + rowId).text(displaySum);
    return sum;
  }
  
  var totalSum = 0;
  {% for nota in notas %}
      var rowSum = calculateRowSum({{ forloop.counter0 }});
      if (!isNaN(rowSum)) {
          totalSum += rowSum;
      }
  {% endfor %}
  var displayTotalSum = totalSum.toFixed(2).replace('.00', '').replace('.', ',');
  $('#ti-f').text(displayTotalSum);
});

</script>
{% endblock content %}
{% comment %}<td class="text-center">{% if nota.materia.literales %}{% if nota.reparacion %}{{ nota.reparacion|literales|default_if_none:'-' }}{% else %}{{ nota.promedio|literales|default_if_none:'-' }}{% endif %}{% else %}{% if nota.reparacion %}{{ nota.reparacion|default_if_none:'-' }}{% else %}{{ nota.promedio|default_if_none:'-' }}{% endif %}{% endif %}</td>{% endcomment %}